<!DOCTYPE html>
<html>

<head>
    <script src="sdk/scripts/VSS.SDK.min.js"></script>
    <script type="text/javascript">
        VSS.init({
            explicitNotifyLoaded: true,
            usePlatformStyles: true
        });

        Date.daysBetween = function(date1, date2) {
            //Get 1 day in milliseconds
            var one_day = 1000 * 60 * 60 * 24;

            // Convert both dates to milliseconds
            var date1_ms = date1.getTime();
            var date2_ms = date2.getTime();

            // Calculate the difference in milliseconds
            var difference_ms = date2_ms - date1_ms;

            // Convert back to days and return
            return Math.round(difference_ms / one_day);
        }

        VSS.require(["TFS/Dashboards/WidgetHelpers", "TFS/WorkItemTracking/RestClient"],
            function(WidgetHelpers, TFS_Wit_WebApi) {
                WidgetHelpers.IncludeWidgetStyles();
                VSS.register("HelloWorldWidget2", function() {
                    var projectId = VSS.getWebContext().project.id;

                    var getQueryInfo = function(widgetSettings) {
                        var client = TFS_Wit_WebApi.getClient();
                        // Get a WIT client to make REST calls to VSTS
                        return client.getQuery(projectId, "Shared Queries/Feedback")
                            .then(function(query) {
                                    var $list;
                                    var intLeadTime = new Array();
                                    // Create a list with query details 
                                    client.queryById(query.id)
                                        .then(function(result) {
                                            function LoadWI(value) {
                                                client.getRevisions(value.id)
                                                    .then(function(workItemRevisions) {
                                                        ////////////////
                                                        function getRevApproved(workItemRevision) {
                                                            return workItemRevision.fields["System.State"] == "Approved";
                                                        }
                                                        var RevApproved = workItemRevisions.find(getRevApproved);

                                                        function getRevDone(workItemRevision) {
                                                            return workItemRevision.fields["System.State"] == "Done";
                                                        }
                                                        var RevDone = workItemRevisions.find(getRevDone);
                                                        ////////////////
                                                        var dateApproved = new Date(RevApproved.fields["System.ChangedDate"]);
                                                        var dateDone = new Date(RevDone.fields["System.ChangedDate"]);

                                                        intLeadTime.push(Date.daysBetween(dateApproved, dateDone));

                                                        var sum = 0;

                                                        function Avg(item) {
                                                            sum += item;
                                                        }
                                                        intLeadTime.forEach(Avg);

                                                        $list = $('<ul>');
                                                        $list.append($('<li>').text("Lead Time Avg (Days): " + (sum / intLeadTime.length)));

                                                        var $container = $('#query-info-container');
                                                        $container.empty();
                                                        $container.append($list);
                                                    });
                                            }
                                            result.workItems.forEach(LoadWI);
                                        });
                                    return WidgetHelpers.WidgetStatusHelper.Success();
                                },
                                function(error) {
                                    return WidgetHelpers.WidgetStatusHelper.Failure(error.message);
                                });
                    }
                    return {
                        load: function(widgetSettings) {
                            var $title = $('h2.title');
                            $title.text('Hello World');

                            return getQueryInfo(widgetSettings);
                        }
                    }
                });
                VSS.notifyLoadSucceeded();
            });
    </script>

</head>

<body>
    <div class="widget">
        <h2 class="title"></h2>
        <div id="query-info-container"></div>
    </div>
</body>

</html>