{"version":3,"sources":["../src/KpiAgile.js"],"names":[],"mappings":"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","file":"KpiAgile.js","sourcesContent":["var intLeadTime = new Array();\r\nvar nWIP = new Array();\r\nvar countWorkItems = 0;\r\nvar settings = null;\r\nvar dtStartThroughput = new Date();\r\nvar dtEndThroughput = new Date(1969);\r\nvar client = null;\r\n\r\nVSS.init({\r\n    explicitNotifyLoaded: true,\r\n    usePlatformStyles: true\r\n});\r\n\r\nVSS.require([\"TFS/Dashboards/WidgetHelpers\", \"TFS/WorkItemTracking/RestClient\"],\r\n    function(WidgetHelpers, TFS_Wit_WebApi) {\r\n        WidgetHelpers.IncludeWidgetStyles();\r\n        VSS.register(\"LeadTimeMetric\", function() {\r\n            var getLeadTime = function(widgetSettings) {\r\n\r\n                // Get a WIT client to make REST calls to VSTS\r\n                client = TFS_Wit_WebApi.getClient();\r\n                var projectId = VSS.getWebContext().project.id;\r\n                settings = JSON.parse(widgetSettings.customSettings.data);\r\n                if (!settings || !settings.queryPath) {\r\n                    $('#query-info-container').empty().text(\"0\");\r\n                    $('#footer').empty().text(\"Please configure a query path\");\r\n                    return WidgetHelpers.WidgetStatusHelper.Success();\r\n                }\r\n                if (WidgetHelpers.WidgetEvent.ConfigurationChange) {\r\n                    $('#error').empty();\r\n                    $('h2.title').text(\"\");\r\n                    $('#query-info-container').empty().text(\"\");\r\n                    $(\"<img></img>\").attr(\"src\", \"img/loadingAnimation.gif\").appendTo($('#query-info-container'));\r\n                    $('#footer').empty().text(\"...\");\r\n\r\n                    //Get a tfs query to get it's id\r\n                    return client.getQuery(projectId, settings.queryPath).then(query => {\r\n                            //Get query result\r\n                            client.queryById(query.id).then(ResultQuery,\r\n                                function(error) {\r\n                                    $('#error').text(\"There is an error in query \" + settings.queryPath.substr(15) + \": \" + error.message);\r\n                                    return WidgetHelpers.WidgetStatusHelper.Failure(error.message);\r\n                                });\r\n                            return WidgetHelpers.WidgetStatusHelper.Success();\r\n                        },\r\n                        function(error) {\r\n                            return WidgetHelpers.WidgetStatusHelper.Failure(error.message);\r\n                        }\r\n                    );\r\n                }\r\n            };\r\n\r\n            return {\r\n                load: function(widgetSettings) {\r\n                    // var $title = $('h2.title');\r\n                    // $title.text('Lead Time');\r\n                    return getLeadTime(widgetSettings);\r\n                },\r\n                reload: function(widgetSettings) {\r\n                    return getLeadTime(widgetSettings);\r\n                }\r\n            };\r\n        });\r\n        VSS.notifyLoadSucceeded();\r\n    }\r\n);\r\n\r\nfunction ResultQuery(resultQuery) {\r\n\r\n    //ForEach workItem in query, get the respective Revision\r\n    intLeadTime = new Array();\r\n    if (resultQuery.queryType == 1) { //flat query\r\n        countWorkItems = resultQuery.workItems.length;\r\n        if (countWorkItems > 0) {\r\n            resultQuery.workItems.forEach(workItem => {\r\n                if (workItem.Fields[\"System.State\"] != \"Done\") {\r\n                    nWIP.Add(1);\r\n                }\r\n                client.getRevisions(workItem.id).then(ProcessRevisions);\r\n            });\r\n        }\r\n    } else {\r\n        countWorkItems = resultQuery.workItemRelations.length;\r\n        if (countWorkItems > 0) {\r\n            resultQuery.workItemRelations.forEach(workItem => {\r\n                client.getRevisions(workItem.target.id).then(ProcessRevisions);\r\n            });\r\n        }\r\n    }\r\n    if (countWorkItems == 0) {\r\n        $('#error').empty();\r\n        $('h2.title').text(settings.queryPath.substr(15));\r\n        $('#query-info-container').empty().text(\"-\");\r\n        $('#footer').empty().text(\"This query does not return any work items\");\r\n        return WidgetHelpers.WidgetStatusHelper.Success();\r\n    }\r\n}\r\n\r\nfunction ProcessRevisions(workItem) {\r\n\r\n    if (workItem[workItem.length - 1].fields[\"System.State\"] != \"Done\") {\r\n        intLeadTime.push(1);\r\n        return;\r\n    }\r\n    var RevApproved = workItem.find(workItemRevision => {\r\n        return workItemRevision.fields[\"System.State\"] == \"Approved\";\r\n    });\r\n\r\n    var RevDone = workItem.find(workItemRevision => {\r\n        return workItemRevision.fields[\"System.State\"] == \"Done\";\r\n    });\r\n\r\n    var dateApproved = (RevApproved != null && RevApproved.fields != undefined) ? new Date(RevApproved.fields[\"System.ChangedDate\"]) : new Date();\r\n    var dateDone = (RevDone != null && RevDone.fields != undefined) ? new Date(RevDone.fields[\"System.ChangedDate\"]) : new Date();\r\n\r\n    //Throughput - Range date\r\n    if (dtStartThroughput > dateApproved) {\r\n        dtStartThroughput = dateApproved;\r\n    }\r\n    if (dtEndThroughput < dateDone) {\r\n        dtEndThroughput = dateDone;\r\n    }\r\n\r\n    intLeadTime.push(1);\r\n\r\n    ShowResult();\r\n}\r\n\r\nfunction ShowResult() {\r\n    if (countWorkItems == intLeadTime.length) {\r\n        var tsIntervaloTotal = DaysBetween(dtStartThroughput, dtEndThroughput)\r\n\r\n        $('#error').empty();\r\n        $('h2.title').text(settings.queryPath.substr(15));\r\n\r\n        var cycleTime = (tsIntervaloTotal / intLeadTime.length);\r\n\r\n        var sumWIP = 0;\r\n        nWIP.forEach(item => {\r\n            sumWIP += item;\r\n        });\r\n        if (settings.metric == \"cycletime\") {\r\n\r\n            $('#query-info-container').empty().html(Math.round(cycleTime * 10) / 10);\r\n            $('#footer').empty().text(\"(Cycle Time) Days per Item\");\r\n        } else if (settings.metric == \"throughput\") {\r\n            // var throughput = (intLeadTime.length / tsIntervaloTotal);\r\n            // $('#query-info-container').empty().html(Math.round(throughput * 100) / 100);\r\n            // $('#footer').empty().text(\"(Throughput) Items per Day\");\r\n            var throughputPerWeek = (intLeadTime.length / (tsIntervaloTotal / 7));\r\n            $('#query-info-container').empty().html(Math.round(throughputPerWeek * 10) / 10);\r\n            $('#footer').empty().text(\"(Throughput) Items per Week\");\r\n        } else if (settings.metric == \"leadtime\") {\r\n            var leadTime = (sumWIP * cycleTime); //---\"WIP * CycleTime\" ou \"WIP / Throughput\r\n            $('#query-info-container').empty().html(Math.round(leadTime * 10) / 10);\r\n            $('#footer').empty().text(\"(Lead Time) Estimate in Days\");\r\n        }\r\n\r\n    }\r\n}\r\n\r\nfunction DaysBetween(date1, date2) {\r\n    //Get 1 day in milliseconds\r\n    var one_day = 1000 * 60 * 60 * 24;\r\n\r\n    // Convert both dates to milliseconds\r\n    var date1_ms = date1.getTime();\r\n    var date2_ms = date2.getTime(); //\r\n\r\n    // Calculate the difference in milliseconds\r\n    var difference_ms = date2_ms - date1_ms;\r\n\r\n    // Convert back to days and return\r\n    return Math.round(difference_ms / one_day);\r\n}"]}